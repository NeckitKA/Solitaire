//---------------------------------------------------------------------------

#pragma hdrstop

#include "Stack.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
//---------------------------------------------------------------------------

Stack::Stack(int n, int x, int y, TForm* parentForm){

	 stack = new TImage(parentForm);

	 stack->Width = 102;
	 stack->Height = 146;

	 stack->Name = "Stack_" + IntToStr(n);
	 stack->Parent = parentForm;
	 stack->Center=true;
	 stack->Transparent=true;
	 stack->Picture->LoadFromFile("resources/images/stack102x146.png");

	 SetX(x);
	 SetY(y);
	 SetStackNumber(n);
	 SetTopCardXPosition();
	 SetTopCardYPosition();
	 SendToBack();
	 GetTImage()->OnMouseDown = OnMouseDown;


}
//---------------------------------------------------------------------------

int Stack::GetStackNumber() const {
	return stackNumber;
}
//---------------------------------------------------------------------------

int  Stack::GetTopCardXPosition() const {
	return topCardXPosition;
}
//---------------------------------------------------------------------------


int  Stack::GetTopCardYPosition() const {
	return topCardYPosition;
}
//---------------------------------------------------------------------------

TImage* Stack::GetTImage() const {
	return stack;
}
//---------------------------------------------------------------------------

void Stack::SetStackNumber(int n) {
	stackNumber = n;
}
//---------------------------------------------------------------------------

void  Stack::SetX(int x) {
	if (stack) {
		X = x;
		stack->Left = X;
	}

}
//---------------------------------------------------------------------------

void  Stack::SetY(int y) {
	if (stack) {
		Y = y;
		stack->Top = Y;
	}

}
//---------------------------------------------------------------------------

void  Stack::SetTopCardXPosition() {
	topCardXPosition = X + 1;
}
//---------------------------------------------------------------------------

void  Stack::SetTopCardYPosition() {
	topCardYPosition = Y + 1;
}
//---------------------------------------------------------------------------



void Stack::SendToBack() {
	if (stack) {
		stack->SendToBack();
	}
}
//--------------------------------------------------------------------------

void __fastcall Stack::OnMouseDown(TObject *Sender, TMouseButton Button, TShiftState Shift,
		  int X, int Y) {
	TForm1* form = dynamic_cast<TForm1*>(GetParentForm());

	if (Button == mbRight) {

		Waste* waste = dynamic_cast<Waste*>(form->waste);
		if (!waste->cards.empty()) {
            if ((!form->foundationStacks[0]->cards.empty() && (waste->cards.back()->GetValue()-4)==form->foundationStacks[0]->cards.back()->GetValue()) || ((waste->cards.back()->GetValue())<5 && form->foundationStacks[0]->cards.size()==0)) {
				waste->cards.back()->SetParentStack(form->foundationStacks[0]);
				form->foundationStacks[0]->AddCard(waste->cards.back());
				waste->RemoveCard(waste->cards.size()-1);

			}

			else if ((!form->foundationStacks[1]->cards.empty() && (waste->cards.back()->GetValue()-4)==form->foundationStacks[1]->cards.back()->GetValue()) || ((waste->cards.back()->GetValue())<5 && form->foundationStacks[1]->cards.size()==0)) {
				waste->cards.back()->SetParentStack(form->foundationStacks[1]);
				form->foundationStacks[1]->AddCard(waste->cards.back());
				waste->RemoveCard(waste->cards.size()-1);

			}

			else if ((!form->foundationStacks[2]->cards.empty() && (waste->cards.back()->GetValue()-4)==form->foundationStacks[2]->cards.back()->GetValue()) || ((waste->cards.back()->GetValue())<5 && form->foundationStacks[2]->cards.size()==0)) {
				waste->cards.back()->SetParentStack(form->foundationStacks[2]);
				form->foundationStacks[2]->AddCard(waste->cards.back());
				waste->RemoveCard(waste->cards.size()-1);

			}

			else if ((!form->foundationStacks[3]->cards.empty() && (waste->cards.back()->GetValue()-4)==form->foundationStacks[3]->cards.back()->GetValue()) || ((waste->cards.back()->GetValue())<5 && form->foundationStacks[3]->cards.size()==0)) {
				waste->cards.back()->SetParentStack(form->foundationStacks[3]);
				form->foundationStacks[3]->AddCard(waste->cards.back());
				waste->RemoveCard(waste->cards.size()-1);

			}
		}
	}


}
//---------------------------------------------------------------------------

Stack::~Stack() {
	for (int card = 0; card<cards.size(); ++card) {
		delete cards[card];
	}
    cards.clear();
	if (stack) {
		delete stack;
	}
}
//---------------------------------------------------------------------------

